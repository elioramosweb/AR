<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>p5.js + AR.js con marcador Hiro</title>

  <!-- p5.js primero (creamos el canvas antes de que A-Frame/AR.js inicien) -->
  <script src="https://cdn.jsdelivr.net/npm/p5@1.9.3/lib/p5.min.js"></script>

  <!-- A-Frame y AR.js para A-Frame -->
  <script src="https://unpkg.com/aframe@1.5.0/dist/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ar.js@3.4.5/aframe/build/aframe-ar.js"></script>

  <style>
    body { margin: 0; overflow: hidden; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    /* Ocultamos el canvas de p5 (igual sirve como textura) */
    #p5canvas { position: fixed; left: -9999px; top: -9999px; }
    .hud {
      position: fixed; top: 0; left: 0; right: 0; z-index: 10;
      background: rgba(0,0,0,.5); color: #fff; padding: 6px 10px; font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="hud">Apunta al marcador Hiro. Si no ves nada: usa HTTPS y permite la cámara.</div>

  <!-- Animación p5.js dibujada en un canvas que usaremos como textura -->
  <script>
    new p5(p => {
      let angle = 0;
      let cnv;

      p.setup = () => {
        cnv = p.createCanvas(512, 512);   // 2D canvas
        cnv.id('p5canvas');                // este id se usa en A-Frame como textura
        p.pixelDensity(1);
        p.noStroke();
      };

      p.draw = () => {
        p.clear();                         // fondo transparente para ver la cámara detrás
        p.translate(p.width/2, p.height/2);

        angle += 0.03;
        // Disco pulsante + órbitas simples
        const base = 120 + 20 * Math.sin(angle * 2);
        p.fill(255, 180, 0, 220);
        p.ellipse(0, 0, base * 1.2, base * 1.2);

        for (let i = 0; i < 6; i++) {
          p.push();
          p.rotate(angle + i * p.TWO_PI / 6);
          const r = 150 + 25 * Math.sin(angle * 3 + i);
          p.fill(255, 240 - i * 20, 80, 230);
          p.ellipse(r, 0, 40, 40);
          p.pop();
        }
      };
    });
  </script>

  <!-- Pequeño componente para refrescar la textura del canvas en A-Frame cada frame -->
  <script>
    AFRAME.registerComponent('canvas-updater', {
      tick: function () {
        const mesh = this.el.getObject3D('mesh');
        if (mesh && mesh.material && mesh.material.map) {
          mesh.material.map.needsUpdate = true;
        }
      }
    });
  </script>

  <!-- Escena AR: el plano usa el canvas de p5 (#p5canvas) como textura sobre el marcador Hiro -->
  <a-scene
      embedded
      vr-mode-ui="enabled: false"
      renderer="alpha: true; antialias: true"
      arjs="sourceType: webcam; debugUIEnabled: false; trackingMethod: best">
    
    <!-- Marcador Hiro -->
    <a-marker preset="hiro">
      <!-- Plano de 1x1 "acostado" sobre el marcador (rotación -90° en X) -->
      <a-plane
        position="0 0 0"
        rotation="-90 0 0"
        width="1" height="1"
        material="shader: flat; src: #p5canvas; transparent: true; side: double;"
        canvas-updater>
      </a-plane>
    </a-marker>

    <!-- Cámara AR por defecto -->
    <a-entity camera></a-entity>
  </a-scene>
</body>
</html>

