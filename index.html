<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AR.js + p5.js — Hiro (iOS)</title>

  <!-- Versiones compatibles -->
  <script src="https://unpkg.com/aframe@1.3.0/dist/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ar.js@3.4.5/aframe/build/aframe-ar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.9.3/lib/p5.min.js"></script>

  <style>
    body { margin:0; overflow:hidden; font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif }
    .hud{position:fixed;left:0;right:0;top:0;padding:.6rem .8rem;background:rgba(0,0,0,.55);color:#fff;z-index:10;font-size:.9rem}
    .hud a{color:#9ad}
    .status{position:fixed;right:8px;bottom:8px;padding:.45rem .65rem;border-radius:.45rem;background:rgba(0,0,0,.55);color:#fff;z-index:10;font-size:.85rem}
    #startAR{position:fixed;left:8px;bottom:8px;padding:.5rem .8rem;border:0;border-radius:.5rem;background:#00c37a;color:#082;font-weight:700;z-index:10}
  </style>
</head>
<body>
  <div class="hud">
    Abre esto en <b>Safari (iPhone)</b>, toca <b>Iniciar AR</b> y apunta al
    <a href="https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/HIRO.jpg" target="_blank" rel="noopener">marcador Hiro</a>.
  </div>
  <div class="status" id="status">Estado: esperando inicio…</div>
  <button id="startAR">Iniciar AR</button>

  <a-scene id="scene" embedded renderer="alpha:true;antialias:true"
           vr-mode-ui="enabled:false"
           arjs="sourceType: webcam; facingMode: environment; debugUIEnabled: false;">
    <a-marker id="marker" preset="hiro">
      <!-- Cubo de verificación -->
      <a-box position="0 0.5 0" depth="1" height="1" width="1"
             color="#00c37a" material="opacity:0.85"></a-box>

      <!-- Plano con textura p5 -->
      <a-plane id="p5plane" position="0 0.01 0" rotation="-90 0 0"
               width="1.5" height="1.5"
               material="shader: flat; side: double; transparent: true; src: #p5canvas"
               canvas-texture>
      </a-plane>
    </a-marker>
    <a-entity camera></a-entity>
  </a-scene>

  <script>
    // Asegurar playsinline/muted en el <video> de AR.js (iOS)
    const mo = new MutationObserver(() => {
      document.querySelectorAll('video').forEach(v => {
        v.setAttribute('playsinline',''); v.playsInline = true; v.muted = true;
      });
    });
    mo.observe(document.documentElement, { childList: true, subtree: true });

    // Componente: refresca la textura de canvas cada frame
    AFRAME.registerComponent('canvas-texture', {
      tick(){
        const mesh = this.el.getObject3D('mesh');
        if (!mesh) return;
        const mats = Array.isArray(mesh.material) ? mesh.material : [mesh.material];
        mats.forEach(m => { if (m.map) m.map.needsUpdate = true; });
      }
    });

    // Gesto de usuario para permiso de cámara en iOS
    const startBtn = document.getElementById('startAR');
    const statusEl = document.getElementById('status');
    startBtn.addEventListener('click', async () => {
      try{
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" } }, audio:false });
        stream.getTracks().forEach(t => t.stop()); // AR.js abrirá su propio stream
        statusEl.textContent = 'Estado: ✅ Permiso concedido. Apunta al marcador.';
      }catch(e){
        statusEl.textContent = 'Estado: ❌ ' + e.name + ' — ' + e.message;
      }
    });

    // Mensajes de tracking
    const marker = document.getElementById('marker');
    marker.addEventListener('markerFound', () => statusEl.textContent = 'Estado: ✅ Marcador detectado.');
    marker.addEventListener('markerLost',  () => statusEl.textContent = 'Estado: ⏳ Buscando marcador…');
  </script>

  <script>
    // === p5.js (canvas como textura) ===
    let cnv, t = 0;
    function setup(){
      cnv = createCanvas(512, 512);
      cnv.id('p5canvas');
      pixelDensity(1);
      noStroke();
    }
    function draw(){
      // Fondo animado
      for (let y=0; y<height; y++){
        const c = map(y,0,height,20,40) + 20 * Math.sin(t + y*0.01);
        fill(10, c, 180); rect(0,y,width,1);
      }
      // Figura
      push();
      translate(width/2, height/2);
      const R = 160 + 40*Math.sin(t*1.2);
      const r = 90  + 30*Math.cos(t*1.6);
      const pts = 180;
      fill(255,255,255,220);
      beginShape();
      for (let i=0; i<pts; i++){
        const a = TWO_PI*i/pts;
        const x = (R + r*Math.cos(4*a + t)) * Math.cos(a);
        const y = (R + r*Math.cos(4*a + t)) * Math.sin(a);
        vertex(x,y);
      }
      endShape(CLOSE);
      pop();

      fill(255,240); textAlign(CENTER,CENTER); textSize(18);
      text('p5.js → textura AR', width/2, height-24);

      t += 0.02;
    }
  </script>
</body>
</html>

