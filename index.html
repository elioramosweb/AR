<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AR.js + p5.js — Hiro (iOS fix)</title>

  <!-- A-Frame (versión estable con AR.js 3.4.x) -->
  <script src="https://unpkg.com/aframe@1.4.1/dist/aframe.min.js"></script>
  <!-- AR.js para A-Frame -->
  <script src="https://cdn.jsdelivr.net/npm/ar.js@3.4.5/aframe/build/aframe-ar.js"></script>
  <!-- p5.js -->
  <script src="https://cdn.jsdelivr.net/npm/p5@1.9.3/lib/p5.min.js"></script>

  <style>
    :root { color-scheme: dark light; }
    body { margin: 0; overflow: hidden; font-family: system-ui,-apple-system,"Segoe UI",Roboto,sans-serif; }
    .hud {
      position: fixed; top: 0; left: 0; right: 0; z-index: 10;
      background: rgba(0,0,0,.55); color: #fff; padding: .55rem .8rem; font-size: .9rem;
    }
    .hud a { color: #9ad; }
    .status {
      position: fixed; right: 8px; bottom: 8px; z-index: 10;
      background: rgba(0,0,0,.55); color:#fff; padding:.45rem .65rem; border-radius:.45rem; font-size:.85rem;
    }
    #startAR {
      position: fixed; left: 8px; bottom: 8px; z-index: 10;
      padding: .5rem .8rem; border-radius: .5rem; border: 0;
      background: #00c37a; color:#082; font-weight: 700;
    }
  </style>
</head>
<body>
  <div class="hud">
    Apunta la cámara al
    <a href="https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/HIRO.jpg" target="_blank" rel="noopener">
      marcador Hiro
    </a>. Requisitos en iPhone: <b>HTTPS</b>, abrir en <b>Safari</b>, buena luz, y llenar 30–60% del encuadre.
  </div>
  <div class="status" id="status">Estado: esperando inicio…</div>
  <button id="startAR">Iniciar AR</button>

  <a-scene
    id="scene"
    embedded
    renderer="colorManagement: true; physicallyCorrectLights: true; alpha: true; antialias: true"
    vr-mode-ui="enabled: false"
    arjs="sourceType: webcam; facingMode: environment; debugUIEnabled: false;"
  >
    <!-- Marcador Hiro -->
    <a-marker id="marker" preset="hiro">
      <!-- Cubo de verificación -->
      <a-box position="0 0.5 0" depth="1" height="1" width="1"
             color="#00c37a" material="opacity:0.85"></a-box>

      <!-- Plano para textura dinámica de p5 -->
      <a-plane id="p5plane"
               position="0 0 0"
               rotation="-90 0 0"
               width="1.5" height="1.5"
               material="transparent: true; side: double"
               canvas-texture>
      </a-plane>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    // Componente: asegura que la textura de canvas refresque cada frame
    AFRAME.registerComponent('canvas-texture', {
      init() {
        // asigna material con src al canvas cuando exista
        const el = this.el;
        const attach = () => {
          const cvs = document.getElementById('p5canvas');
          if (cvs) {
            el.setAttribute('material', 'shader: standard; src: #p5canvas; transparent: true; side: double');
          } else {
            setTimeout(at

