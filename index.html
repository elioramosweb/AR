<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AR.js + p5.js — Test marcador Hiro</title>
  <!-- A-Frame -->
  <script src="https://unpkg.com/aframe@1.5.0/dist/aframe.min.js"></script>
  <!-- AR.js para A-Frame -->
  <script src="https://cdn.jsdelivr.net/npm/ar.js@3.4.5/aframe/build/aframe-ar.js"></script>
  <!-- p5.js -->
  <script src="https://cdn.jsdelivr.net/npm/p5@1.9.3/lib/p5.min.js"></script>
  <style>
    body { margin: 0; overflow: hidden; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .hud {
      position: fixed; top: 0; left: 0; right: 0; z-index: 10;
      background: rgba(0,0,0,.55); color: #fff; padding: .5rem .75rem; font-size: .9rem;
    }
    .hud a { color: #9ad; }
    .status {
      position: fixed; right: 8px; bottom: 8px; z-index: 10;
      background: rgba(0,0,0,.55); color:#fff; padding:.4rem .6rem; border-radius: .4rem; font-size: .85rem;
    }
    #testCam {
      position: fixed; left:8px; bottom:8px; z-index: 10;
      padding: .4rem .6rem;
    }
  </style>
</head>
<body>
  <div class="hud">
    Apunta la cámara al
    <a href="https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/HIRO.jpg" target="_blank" rel="noopener">
      marcador Hiro
    </a>.
    Si no ves nada: usa <b>HTTPS</b>, buena luz, y llena 30–60% del encuadre con el marcador (mejor impreso).
  </div>
  <div class="status" id="status">Estado: esperando cámara…</div>
  <button id="testCam">Activar cámara (test)</button>

  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    renderer="colorManagement: true; physicallyCorrectLights: true"
    arjs="sourceType: webcam; trackingMethod: best; facingMode: environment; debugUIEnabled: false;">

    <!-- Marcador Hiro -->
    <a-marker preset="hiro" id="marker">
      <!-- CUBO DE PRUEBA: debe aparecer en cuanto el marcador se detecte -->
      <a-box position="0 0.5 0" depth="1" height="1" width="1" color="#00c37a" material="opacity:0.85"></a-box>

      <!-- PLANO para la textura p5 (más grande, doble cara) -->
      <a-plane id="p5plane"
               position="0 0 0"
               rotation="-90 0 0"
               width="1.5" height="1.5"
               material="transparent: true; side: double">
      </a-plane>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    // --- Botón de diagnóstico: solicita permiso explícito a la cámara ---
    document.getElementById('testCam').addEventListener('click', async () => {
      const status = document.getElementById('status');
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        stream.getTracks().forEach(t => t.stop());
        status.textContent = 'Estado: ✅ Cámara OK (permiso concedido).';
      } catch (e) {
        status.textContent = 'Estado: ❌ ' + e.name + ' — ' + e.message;
      }
    });

    // --- Estado de marcador: muestra si se detecta o no ---
    const status = document.getElementById('status');
    const marker = document.getElementById('marker');
    marker.addEventListener('markerFound', () => {
      status.textContent = 'Estado: ✅ Marcador detectado.';
    });
    marker.addEventListener('markerLost', () => {
      status.textContent = 'Estado: ⏳ Buscando marcador…';
    });
  </script>

  <script>
    // === p5.js: animación 2D para textura dinámica ===
    let cnv, t = 0;
    function setup() {
      cnv = createCanvas(512, 512);
      cnv.id('p5canvas');
      pixelDensity(1);
      noStroke();

      const plane = document.getElementById('p5plane');
      const tryAttach = () => {
        if (plane && document.getElementById('p5canvas')) {
          // Asignamos el canvas como textura y lo dejamos doble cara
          plane.setAttribute('material', 'src: #p5canvas; transparent: true; side: double');
        } else {
          setTimeout(tryAttach, 100);
        }
      };
      tryAttach();
    }

    function draw() {
      // Fondo con gradiente animado
      for (let y = 0; y < height; y++) {
        const c = map(y, 0, height, 20, 40) + 20 * sin(t + y * 0.01);
        fill(10, c, 180);
        rect(0, y, width, 1);
      }
      // Figura pulsante
      translate(width/2, height/2);
      const R = 160 + 40 * sin(t * 1.2);
      const r = 90 + 30 * cos(t * 1.6);
      const pts = 180;
      fill(255, 255, 255, 220);
      beginShape();
      for (let i = 0; i < pts; i++) {
        const a = TWO_PI * i / pts;
        const x = (R + r * cos(4*a + t)) * cos(a);
        const y = (R + r * cos(4*a + t)) * sin(a);
        vertex(x, y);
      }
      endShape(CLOSE);

      // Texto
      resetMatrix();
      fill(255, 240);
      textAlign(CENTER, CENTER);
      textSize(18);
      text('p5.js → textura AR', width/2, height-24);

      t += 0.02;
    }
  </script>
</body>
</html>
